# 聊天室功能测试说明

## 功能实现

### 1. SSE长连接功能
- ✅ 用户进入聊天室时建立SSE连接
- ✅ 用户离开聊天室时自动断开连接
- ✅ 实时通知其他用户有新用户进入/离开

### 2. 用户列表管理
- ✅ 实时显示当前房间内的在线用户
- ✅ 用户进入时自动更新用户列表
- ✅ 用户离开时自动更新用户列表
- ✅ 当前用户高亮显示

### 3. 消息发送和接收
- ✅ 通过API发送消息
- ✅ 通过SSE实时接收消息
- ✅ 消息区分发送者和接收者
- ✅ 支持文本消息类型
- ✅ 避免重复接收自己发送的消息

### 4. 前端界面优化
- ✅ 美观的用户列表界面
- ✅ 用户头像显示
- ✅ 在线用户数量显示
- ✅ 消息列表实时更新

## 测试步骤

### 1. 创建房间
1. 访问首页 `http://localhost:3000`
2. 点击"立即创建"按钮
3. 系统会自动生成用户名并跳转到聊天室

### 2. 多用户测试
1. 打开多个浏览器标签页或浏览器窗口
2. 在首页创建不同的房间，或使用相同房间ID
3. 观察用户列表的实时更新
4. 测试消息发送和接收

### 3. 功能验证
- 用户A进入房间，右侧用户列表显示用户A
- 用户B进入房间，用户A和用户B都能看到两个用户
- 用户A发送消息，用户B能实时收到
- 用户B发送消息，用户A能实时收到
- 用户离开房间，其他用户能看到用户列表更新

## 调试步骤

### 1. 打开浏览器开发者工具
- 按F12打开开发者工具
- 切换到Console标签页

### 2. 观察服务端日志
在终端中运行项目后，观察服务端输出的日志：
```
用户 xxx 进入房间 xxx, 当前房间用户数: 1
房间 xxx 的用户列表: [{uid: 'xxx', username: 'xxx'}]
向房间 xxx 的 0 个用户广播消息: room:user:enter (排除 xxx)
向房间 xxx 的 0 个用户广播消息: room:users:list (排除 xxx)
```

### 3. 观察前端日志
在浏览器控制台中观察：
```
sse event {type: 'room:users:list', data: {users: [...], roomId: 'xxx'}}
收到用户列表更新: [{uid: 'xxx', username: 'xxx'}]
```

### 4. 问题排查
如果用户列表不正确，检查：
1. 服务端是否正确获取了房间内的所有用户
2. 广播消息是否发送给了正确的用户
3. 前端是否正确处理了用户列表更新事件

### 5. 消息重复问题修复
- **问题**：用户发送消息时会看到两条相同的消息
- **原因**：前端直接添加消息到列表，同时通过SSE接收广播消息
- **修复**：
  - 服务端广播消息时排除发送者
  - 前端SSE接收消息时过滤掉自己的消息
  - 确保每个用户只看到自己的消息一次

### 6. 多标签页用户ID冲突问题修复
- **问题**：同一浏览器多个标签页共享localStorage，导致用户ID冲突
- **现象**：
  - Chrome标签页A：用户A
  - Chrome标签页C：覆盖了用户A的ID，变成用户C
  - Edge浏览器：用户B（独立localStorage）
- **修复**：
  - 每个标签页都生成唯一的用户ID
  - 不再依赖localStorage存储用户ID
  - 确保每个标签页都有独立的身份标识

### 7. 无用户名参数问题修复
- **问题**：直接访问房间URL时没有user参数，导致无法进入聊天室
- **现象**：URL为 `/room/123456` 时，页面显示"没有用户名"并无法连接
- **修复**：
  - 使用 `getRandomName()` 自动生成中文用户名（如：可爱的小猫、聪明的小狗）
  - 支持直接访问房间URL
  - 确保所有用户都能正常进入聊天室

### 8. 房间查找API类型错误修复
- **问题**：房间ID类型不匹配导致 `http error` 错误
- **现象**：访问房间时出现 `{ code: -1000, message: 'http error' }` 错误
- **原因**：数据库 `room_id` 字段是字符串类型，但服务层参数类型定义为数字
- **修复**：
  - 修改 `RoomService.findByRoomId` 参数类型从 `number` 改为 `string`
  - 在API调用时确保房间ID转换为字符串类型
  - 解决房间查找失败的问题

### 9. 性能优化：房间用户管理
- **问题**：使用单一Map存储所有客户端，导致线性搜索性能问题
- **现象**：用户数量增长时，获取房间用户和广播消息性能下降
- **优化方案**：
  - 添加房间用户映射：`Map<房间ID, Set<用户ID>>`
  - 优化用户查找：O(1) 时间复杂度获取房间用户
  - 优化消息广播：直接通过房间ID获取目标用户
  - 自动清理空房间：房间无用户时自动删除记录
- **性能提升**：
  - 获取房间用户：从 O(n) 优化到 O(k)，k为房间用户数
  - 广播消息：从 O(n) 优化到 O(k)
  - 内存使用：减少不必要的遍历操作

## API接口

### SSE连接
```
GET /api/sse/room?user=用户名&uid=用户ID&roomId=房间ID
```

### 发送消息
```
POST /api/room/message
Content-Type: application/json

{
  "roomId": "房间ID",
  "user": "用户名",
  "uid": "用户ID", 
  "content": "消息内容",
  "type": "text"
}
```

## SSE事件类型

- `room:users:list` - 用户列表更新
- `room:user:enter` - 用户进入通知
- `room:user:leave` - 用户离开通知
- `room:message` - 新消息通知
